name: pr-automation-all-in-one

on:
  pull_request:
    # opened: 作成時, edited: 本文編集時, synchronize: コミット追加時
    types: [opened, edited, synchronize, ready_for_review]

# 並行実行の制御：同じPRで新しい動きがあったら古い実行をキャンセルして節約
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  automation:
    runs-on: ubuntu-latest
    # ジョブ単位で必要な書き込み権限を付与
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4 # 0. まずリポジトリを読み込む
      
      # ステップ1：PRサイズ（レビューコスト）ラベルの自動更新
      - name: Update review labels
        id: label_step # 後で参照するために ID を付ける
        uses: actions/github-script@v7
        with:
          script: |
            // 現在のラベル一覧を取得
            const { data: labels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const currentReviewLabels = labels.map(l => l.name).filter(n => n.startsWith('review:'));

            // PR本文のチェックボックスから [x] small/medium/large を抽出
            const body = context.payload.pull_request.body || "";
            const matches = [...body.matchAll(/- \[x\]\s*(small|medium|large)/gi)];
            const labelsToBe = Array.from(new Set(matches.map(m => `review:${m[1].toLowerCase()}`)));

            // 不要になったラベルの削除と、新しいラベルの追加
            const toRemove = currentReviewLabels.filter(n => !labelsToBe.includes(n));
            const toAdd = labelsToBe.filter(n => !currentReviewLabels.includes(n));

            for (const name of toRemove) {
              await github.rest.issues.removeLabel({ ...context.repo, issue_number: context.issue.number, name });
            }
            if (toAdd.length > 0) {
              await github.rest.issues.addLabels({ ...context.repo, issue_number: context.issue.number, labels: toAdd });
            }
            
            // 最後に、決まったラベルを「出力」として保存する
            core.setOutput('applied_labels', labelsToBe.join(', ') || 'none');
            
      # ステップ2：作成者をアサイン（PR作成時のみ実行）
      - name: Assign author
        if: github.event.action == 'opened' || github.event.action == 'ready_for_review'
        run: gh pr edit ${{ github.event.pull_request.number }} --add-assignee ${{ github.actor }}
        env:
          GH_TOKEN: ${{ github.token }} # GitHub公式のCLIツールを使用

      # ステップ3：Slack通知
      - name: Slack Notification
        if: always()
        run: |
          # 前のステップの出力を変数に入れる
          LABELS="${{ steps.label_step.outputs.applied_labels }}"
          LOG_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"text\": \"*PR Automation Result* \nLabels: ${LABELS} \nLog: <${LOG_URL}|View Details>\"
          }" $SLACK_WEBHOOK_URL
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
