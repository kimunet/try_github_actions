name: PR Size Labeler

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  label-size:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Fetch base branch
        run: |
          BASE_REF=${{ github.event.pull_request.base.ref }}
          git fetch origin ${BASE_REF}:refs/remotes/origin/${BASE_REF}

      - name: Calculate changed lines
        id: calc
        run: |
          BASE_REF=${{ github.event.pull_request.base.ref }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}
          PR_NUMBER=${{ github.event.pull_request.number }}
          CHANGED_LINES=$(git diff --numstat origin/${BASE_REF}...${HEAD_SHA} | awk '{added+=$1; deleted+=$2} END {print added+deleted+0}')
          if [ -z "$CHANGED_LINES" ]; then CHANGED_LINES=0; fi
          echo "changed_lines=$CHANGED_LINES" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

      - name: Determine label
        id: label
        run: |
          LINES=${{ steps.calc.outputs.changed_lines }}
          if [ "$LINES" -lt 10 ]; then LABEL="size/XS"; elif [ "$LINES" -lt 50 ]; then LABEL="size/S"; elif [ "$LINES" -lt 200 ]; then LABEL="size/M"; elif [ "$LINES" -lt 500 ]; then LABEL="size/L"; else LABEL="size/XL"; fi
          echo "label=$LABEL" >> $GITHUB_OUTPUT

      - name: Remove old size labels (best-effort)
        run: |
          PR_NUMBER=${{ steps.calc.outputs.pr_number }}
          OWNER_REPO=${{ github.repository }}
          TOKEN=${{ secrets.GITHUB_TOKEN }}
          for L in "size/XS" "size/S" "size/M" "size/L" "size/XL"; do
            curl -s -X DELETE -H "Authorization: token ${TOKEN}" -H "Accept: application/vnd.github+json" "https://api.github.com/repos/${OWNER_REPO}/issues/${PR_NUMBER}/labels/${L}" || true
          done

      - name: Add size label
        run: |
          PR_NUMBER=${{ steps.calc.outputs.pr_number }}
          OWNER_REPO=${{ github.repository }}
          TOKEN=${{ secrets.GITHUB_TOKEN }}
          LABEL=${{ steps.label.outputs.label }}
          curl -s -X POST -H "Authorization: token ${TOKEN}" -H "Accept: application/vnd.github+json" "https://api.github.com/repos/${OWNER_REPO}/issues/${PR_NUMBER}/labels" -d "{\"labels\":[\"${LABEL}\"]}"
